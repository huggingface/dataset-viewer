version: "3.9"
services:
  reverse-proxy:
    image: nginx:1.20
    volumes:
      - ../chart/nginx-templates/:/etc/nginx/templates:ro
      - reverse-proxy-cache:/nginx-cache
      - assets:/assets:ro
      - ../chart/static-files/openapi.json:/static-files/openapi.json:ro
    ports:
      - ${PORT_REVERSE_PROXY-8000}:80
    environment:
      ASSETS_DIRECTORY: "/assets"
      HOST: localhost"
      PORT: 80
      URL_ADMIN: "http://admin:8081"
      URL_API: "http://api:8080"
    depends_on:
      api:
        condition: service_started
  api:
    build:
      context: ..
      dockerfile: services/api/Dockerfile
    volumes:
      - assets:/assets:ro
    environment:
      API_UVICORN_HOSTNAME: 0.0.0.0
      API_UVICORN_NUM_WORKERS: 1
      API_UVICORN_PORT: 8080
      CACHE_ASSETS_DIRECTORY: "/assets"
      COMMON_HF_ENDPOINT: ${COMMON_HF_ENDPOINT}
      COMMON_HF_TOKEN: ${COMMON_HF_TOKEN}
      CACHE_MONGO_URL: "mongodb://mongodb"
      QUEUE_MONGO_URL: "mongodb://mongodb"
    ports:
      # for debug
      - ${API_UVICORN_PORT-8080}:8080
    depends_on:
      mongodb:
        condition: service_started
    restart: unless-stopped
  worker-splits:
    build:
      context: ..
      dockerfile: ./workers/splits/Dockerfile
    volumes:
      - datasets-cache:/datasets-cache:rw
    environment:
      HF_DATASETS_CACHE: "/datasets-cache"
      COMMON_HF_ENDPOINT: ${COMMON_HF_ENDPOINT}
      COMMON_HF_TOKEN: ${COMMON_HF_TOKEN}
      CACHE_MONGO_URL: "mongodb://mongodb"
      QUEUE_MONGO_URL: "mongodb://mongodb"
    depends_on:
      mongodb:
        condition: service_started
    restart: always
  worker-first-rows:
    build:
      context: ..
      dockerfile: ./workers/first_rows/Dockerfile
    volumes:
      - assets:/assets:rw
      - datasets-cache:/datasets-cache:rw
    environment:
      COMMON_ASSETS_BASE_URL: "http://localhost:${PORT_REVERSE_PROXY-8000}/assets"
      CACHE_ASSETS_DIRECTORY: "/assets"
      HF_DATASETS_CACHE: "/datasets-cache"
      COMMON_HF_ENDPOINT: ${COMMON_HF_ENDPOINT}
      COMMON_HF_TOKEN: ${COMMON_HF_TOKEN}
      CACHE_MONGO_URL: "mongodb://mongodb"
      QUEUE_MONGO_URL: "mongodb://mongodb"
    depends_on:
      mongodb:
        condition: service_started
    restart: always
  admin:
    build:
      context: ..
      dockerfile: ./services/admin/Dockerfile
    environment:
      ADMIN_UVICORN_HOSTNAME: 0.0.0.0
      ADMIN_UVICORN_NUM_WORKERS: 1
      ADMIN_UVICORN_PORT: 8081
      CACHE_ASSETS_DIRECTORY: "/assets"
      CACHE_MONGO_URL: "mongodb://mongodb"
      QUEUE_MONGO_URL: "mongodb://mongodb"
    ports:
      # for debug
      - ${ADMIN_UVICORN_PORT-8081}:8081
    depends_on:
      mongodb:
        condition: service_started
    restart: always
  mongodb:
    image: mongo
    volumes:
      - mongo:/data/db:rw
    ports:
      # for debug
      - "${MONGO_PORT-27017}:27017"
volumes:
  assets:
  datasets-cache:
  mongo:
  reverse-proxy-cache:
