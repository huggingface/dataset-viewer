# SPDX-License-Identifier: Apache-2.0
# Copyright 2022 The HuggingFace Authors.

# --- common parameters ---

global:
  huggingface:
    service:
      ports:
        datasetsServer:
          proxy: 30931
          admin: 32702
          api: 31370
          rows: 31371

images:
  pullPolicy: IfNotPresent
  pullSecrets: []
  reverseProxy:
    useGlobalRegistry: false
    registry: docker.io
    repository: nginx
    tag: "1.20"
  jobs:
    mongodbMigration:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-jobs-mongodb_migration
      tag: sha-fb3399a
    cacheMaintenance:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-jobs-cache_maintenance
      tag: sha-fb3399a
  services:
    admin:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-services-admin
      tag: sha-fb3399a
    api:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-services-api
      tag: sha-fb3399a
    rows:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-services-rows
      tag: sha-fb3399a
    worker:
      registry: huggingface
      useGlobalRegistry: false
      repository: datasets-server-services-worker
      tag: sha-fb3399a

secrets:
  externalSecret:
    enabled: true
    secretName: "datasets-server-prod-secrets"
    secretStoreName: "datasets-server-prod-secretstore"
    parameters:
      MONGO_URL: "hub-prod-datasets-server-mongo-url"
      HF_TOKEN: "hub-prod-datasets-server-hf-token"
      PARQUET_CONVERTER_HF_TOKEN: "hub-prod-datasets-server-parquet-converter-hf-token"
      WEBHOOK_SECRET: "hub-prod-datasets-server-webhook-secret"
      SPAWNING_TOKEN: "hub-prod-datasets-server-spawning-token"
  mongoUrl:
    fromSecret: true
    secretName: "datasets-server-prod-secrets"
  appHfToken:
    fromSecret: true
    secretName: "datasets-server-prod-secrets"
  appParquetConverterHfToken:
    fromSecret: true
    secretName: "datasets-server-prod-secrets"
  hfWebhookSecret:
    fromSecret: true
    secretName: "datasets-server-prod-secrets"
  spawningToken:
    fromSecret: true
    secretName: "datasets-server-prod-secrets"

persistence:
  existingClaim: "nfs-datasets-server-pvc"

cachePersistence:
  existingClaim: "datasets-server-cache-pvc"

parquetPersistence:
  existingClaim: "datasets-server-parquet-pvc"

duckdbPersistence:
  existingClaim: "datasets-server-duckdb-pvc"

monitoring:
  enabled: true

mongodb:
  enabled: false

common:
  # URL of the HuggingFace Hub
  hfEndpoint: "https://huggingface.co"

log:
  # Log level
  level: "INFO"

firstRows:
  maxBytes: "200_000"

parquetAndInfo:
  maxDatasetSize: "5_000_000_000"
  maxRowGroupByteSizeForCopy: "500_000_000"
  blockedDatasets: "1aurent/icdar-2011,abdusahmbzuai/masc_dev,Abuelnour/json_1000_Scientific_Paper,ACL-OCL/acl-anthology-corpus,adamlin/daily_dialog,albertvillanova/TextCaps,alkzar90/CC6204-Hackaton-Cub-Dataset,allenai/nllb,ami,andite/riyo-tag,andreagasparini/librispeech_test_only,andreagasparini/librispeech_train_clean_only,andreagasparini/librispeech_train_other_only,angelolab/ark_example,anonymousdeepcc/DeepCC,arpelarpe/nota,asapp/slue,ashraf-ali/quran-data,ashraq/dhivehi-corpus,autoevaluator/shoes-vs-sandals-vs-boots,azraahmadi/autotrain-data-xraydatasetp2,backslashlim/LoRA-Datasets,bengaliAI/cvbn,benschill/brain-tumor-collection,beyond/chinese_clean_passages_80m,bigbio/anat_em,bigbio/ctebmsp,bigbio/distemist,bigbio/ebm_pico,bigcode/the-stack-username-to-repo,biglam/brill_iconclass,biglam/early_printed_books_font_detection,biglam/gallica_literary_fictions,biglam/nls_chapbook_illustrations,bigscience-biomedical/anat_em,bigscience-biomedical/ebm_pico,bigscience-biomedical/evidence_inference,bigscience/massive-probing-results,bigscience/P3,bigscience/xP3,bio-datasets/e3c,Biomedical-TeMU/ProfNER_corpus_classification,Biomedical-TeMU/ProfNER_corpus_NER,Biomedical-TeMU/SPACCC_Sentence-Splitter,biwi_kinect_head_pose,bnl_newspapers,bruno-cotrim/arch-max,cahya/fleurs,cahya/librivox-indonesia,cameronbc/synthtiger,Carlisle/msmarco-passage-non-abs,castorini/msmarco_v1_passage_doc2query-t5_expansions,cats_vs_dogs,ccdv/arxiv-summarization,ccdv/cnn_dailymail,ccdv/mediasum,ChaiML/AnthropicRLHFPreferenceData,Champion/vpc2020_clear_anon_speech,chenghao/scielo_books,chrisjay/mnist-adversarial-dataset,cjvt/cc_gigafida,cjvt/slo_collocations,cjvt/sloleks,clarin-pl/multiwiki_90k,cmudrc/porous-microstructure-strain-fields,CodedotAI/code_clippy,common_language,competition_math,cooleel/xfund_de,corentinm7/MyoQuant-SDH-Data,cornell_movie_dialog,CristianaLazar/librispeech500,CristianaLazar/librispeech5k_train,crystina-z/miracl-bm25-negative,crystina-z/mmarco,crystina-z/mmarco-corpus,crystina-z/msmarco-passage-dl19,crystina-z/msmarco-passage-dl20,crystina-z/no-nonself-mrtydi,crystina-z/xor-tydi-corpus,dalle-mini/YFCC100M_OpenAI_subset,darkproger/librispeech_asr,DavidVivancos/MindBigData2022_Imagenet_IN_Spct,DelgadoPanadero/Pokemon,dgrnd4/stanford_dog_dataset,dlwh/MultiLegalPile_Wikipedia_Shuffled,dog/punks,ds4sd/DocLayNet,DTU54DL/librispeech5k-augmentated-train-prepared,echarlaix/gqa-lxmert,echarlaix/vqa,echarlaix/vqa-lxmert,EfaceD/ElysiumInspirations,evidence_infer_treatment,fcakyon/gun-object-detection,florianbussmann/train_tickets-yu2020pick,galman33/gal_yair_166000_256x256_fixed,GEM/BiSECT,GEM/references,GEM/xsum,genjib/LAVISHData,gigant/african_accented_french,gigant/m-ailabs_speech_dataset_fr,gigant/romanian_speech_synthesis_0_8_1,google/fleurs,Graphcore/gqa,Graphcore/gqa-lxmert,Graphcore/vqa,Graphcore/vqa-lxmert,grasshoff/lhc_sents,guangguang/azukijpg,HamdiJr/Egyptian_hieroglyphs,hebrew_projectbenyehuda,helena-balabin/sentences,hr16/Miwano-Rag,huggan/anime-faces,HuggingFaceM4/charades,HuggingFaceM4/cm4-synthetic-testing,HuggingFaceM4/COCO,HuggingFaceM4/epic_kitchens_100,HuggingFaceM4/FairFace,HuggingFaceM4/general-pmd-synthetic-testing,HuggingFaceM4/TextCaps,HuggingFaceM4/TGIF,HuggingFaceM4/VQAv2,HuggingFaceM4/yttemporal180m,HugoLaurencon/IIIT-5K,HugoLaurencon/libri_light,HugoLaurencon/libri_light_bytes,icelab/ntrs_meta,ilhanemirhan/eee543,iluvvatar/RuREBus,imvladikon/paranames,indonesian-nlp/librivox-indonesia,inseq/divemt_attributions,Isma/librispeech_1000_seed_42,izumaru/os2-datasets,jamescalam/movielens-25m-ratings,jamescalam/unsplash-25k-images,jerpint/imagenette,jimregan/clarinpl_sejmsenat,jimregan/clarinpl_studio,joefox/Mozilla_Common_Voice_ru_test_noise,joelito/lextreme,joelito/MultiLegalPile_Wikipedia_Filtered,jpwahle/dblp-discovery-dataset,kaliansh/sdaia,Karavet/ILUR-news-text-classification-corpus,keremberke/garbage-object-detection,keremberke/nfl-object-detection,keremberke/protective-equipment-detection,keremberke/smoke-object-detection,keshan/clean-si-mc4,keshan/multispeaker-tts-sinhala,KETI-AIR/vqa,khalidalt/tydiqa-primary,KnutJaegersberg/Interpretable_word_embeddings_large_cskg,KokeCacao/oracle,kresnik/librispeech_asr_test,ksaml/Stanford_dogs,Lacito/pangloss,lafi23333/ds,LanceaKing/asvspoof2019,Lehrig/GTZAN-Collection,Lehrig/Monkey-Species-Collection,LeoFeng/MLHW_6,leviethoang/VBVLSP,Leyo/TGIF,Livingwithmachines/MapReader_Data_SIGSPATIAL_2022,lj_speech,Lykon/OnePiece,m-aliabbas/idrak_splitted_amy_1,malteos/paperswithcode-aspects,marinone94/nst_no,marinone94/nst_sv,matallanas/linustechtips-transcript-audio-mp3,matallanas/linustechtips-transcript-audio-ogg,matallanas/linustechtips-transcript-audio-wav,matchbench/dbp15k-fr-en,mathaillah/BeritaHoaks-NonHoaks,mbarnig/lb-de-fr-en-pt-12800-TTS-CORPUS,mc4,mesolitica/dbp,mesolitica/noisy-en-ms-augmentation,mesolitica/noisy-ms-en-augmentation,mesolitica/translated-SQUAD,metashift,miracl/miracl,momilla/Ethereum_transacitons,MorVentura/TRBLLmaker,mozilla-foundation/common_voice_1_0,mozilla-foundation/common_voice_10_0,mozilla-foundation/common_voice_2_0,mozilla-foundation/common_voice_3_0,mozilla-foundation/common_voice_4_0,mozilla-foundation/common_voice_5_0,mozilla-foundation/common_voice_5_1,mozilla-foundation/common_voice_6_0,mozilla-foundation/common_voice_7_0,mteb/results,mteb/tatoeba-bitext-mining,muchocine,Muennighoff/flores200,mulcyber/europarl-mono,multilingual_librispeech,Murple/mmcrsc,mwhanna/ACT-Thor,mwitiderrick/arXiv,nanom/splittedspanish3bwc,Nart/parallel-ab-ru,nateraw/auto-cats-and-dogs,nateraw/imagenet-sketch,nateraw/quickdraw,nateraw/rice-image-dataset,nateraw/rice-image-dataset-2,nateraw/wit,NeuroSenko/senko_anime_full,nev/anime-giph,nishita/ade20k-sample,NLPC-UOM/document_alignment_dataset-Sinhala-Tamil-English,nlphuji/utk_faces,nlphuji/vasr,nlphuji/winogavil,nuprl/MultiPL-E,nuprl/MultiPL-E-raw-data,nvm472001/cvdataset-layoutlmv3,nyanko7/yandere-images,openclimatefix/era5,openclimatefix/nimrod-uk-1km-validation,openslr,opus_euconst,orieg/elsevier-oa-cc-by,oyk100/ChaSES-data,parambharat/kannada_asr_corpus,parambharat/malayalam_asr_corpus,parambharat/mile_dataset,parambharat/telugu_asr_corpus,Pinguin/images,plncmm/wl-disease,plncmm/wl-family-member,polinaeterna/vox_lingua,PolyAI/evi,Poupou/Gitcoin-Grant-DataBuilder,pragnakalp/squad_v2_french_translated,qanastek/MASSIVE,qanastek/QUAERO,raghav66/whisper-gpt,RaphaelOlivier/whisper_adversarial_examples,RAYZ/Mixed-Dia,reazon-research/reazonspeech,robertmyers/pile_v2,Rodion/uno_sustainable_development_goals,rogerdehe/xfund,rohitp1/librispeech_asr_clean,rossevine/tesis,SamAct/medium_cleaned,Samip/Scotch,sanchit-gandhi/librispeech_asr_clean,SaulLu/Natural_Questions_HTML_reduced_all,SDbiaseval/dataset-dalle,SetFit/mnli,severo/wit,shanya/crd3,shunk031/cocostuff,shunk031/livedoor-news-corpus,sil-ai/audio-keyword-spotting,sil-ai/audio-kw-in-context,sjpmpzx/qm_ly_gy_soundn,sled-umich/Action-Effect,SLPL/naab-raw,SocialGrep/ten-million-reddit-answers,SocialGrep/the-reddit-climate-change-dataset,society-ethics/lila_camera_traps,Sreyan88/librispeech_asr,stas/openwebtext-10k,strombergnlp/broad_twitter_corpus,student/celebA,superb,tab_fact,TalTechNLP/VoxLingua107,tapaco,tau/mrqa,tau/scrolls,tensorcat/wikipedia-japanese,Tevatron/beir-corpus,Tevatron/wikipedia-curated-corpus,Tevatron/wikipedia-squad,Tevatron/wikipedia-squad-corpus,Tevatron/wikipedia-trivia-corpus,Tevatron/wikipedia-wq-corpus,Tevatron/xor-tydi-corpus,texturedesign/td01_natural-ground-textures,textvqa,the_pile,tilos/ASR-CCANTCSC,tner/wikiann,TomTBT/pmc_open_access_figure,TomTBT/pmc_open_access_section,Tristan/olm-october-2022-tokenized-1024-exact-dedup-only,turkic_xwmt,universal_morphologies,uva-irlab/trec-cast-2019-multi-turn,valurank/PoliticalBias_AllSides_Txt,vblagoje/wikipedia_snippets_streamed,vctk,VIMA/VIMA-Data,Voicemod/LibriTTS-100-preproc,voidful/librispeech_asr_text,web_nlg,Whispering-GPT/linustechtips-transcript-audio,winvoker/lvis,wmt/europarl,xglue,Yehor/ukrainian-tts-lada,yhavinga/ccmatrix,ywchoi/mdpi_sept10,YWjimmy/PeRFception-ScanNet,YWjimmy/PeRFception-v1,YWjimmy/PeRFception-v1-1,YWjimmy/PeRFception-v1-2,YWjimmy/PeRFception-v1-3,z-uo/female-LJSpeech-italian,ZihaoLin/zhlds,zyznull/dureader-retrieval-ranking,zyznull/msmarco-passage-corpus,zyznull/msmarco-passage-ranking"
  supportedDatasets: "bigcode/the-stack"
  noMaxSizeLimitDatasets: "Open-Orca/OpenOrca"

optInOutUrlsScan:
  maxConcurrentRequestsNumber: 100
  maxRequestsPerSecond: 50
  rowsMaxNumber: 100_000
  urlsNumberPerBatch: 1000


# --- jobs (pre-install/upgrade hooks) ---

mongodbMigration:
  nodeSelector:
    role-datasets-server: "true"
  resources:
    requests:
      cpu: 1
    limits:
      cpu: 1

# --- jobs (post-upgrade hooks) ---

cacheMaintenance:
  action: "skip"
  # ^ allowed values are {backfill, collect-metrics,skip}
  log:
    level: "debug"
  backfill:
    error_codes_to_retry: ""
  resources:
    requests:
      cpu: 1
      memory: "2Gi"
    limits:
      cpu: 2
      memory: "8Gi"

# --- cron jobs  ---
backfill:
  enabled: true
  log:
    level: "debug"
  action: "backfill"
  error_codes_to_retry: "CreateCommitError,LockedDatasetTimeoutError"
  schedule: "00 12 * * *"
  # every day at 12:00
  nodeSelector: {}
  resources:
    requests:
      cpu: 1
    limits:
      cpu: 1
      memory: "512Mi"
  tolerations: []

metricsCollector:
  action: "collect-metrics"
  schedule: "*/2 * * * *"
  # every two minutes
  nodeSelector: {}
  resources:
    requests:
      cpu: 1
    limits:
      cpu: 1
      memory: "512Mi"
  tolerations: []

# --- storage admin (to manually inspect the storage, in /data) ---

storageAdmin:
  nodeSelector:
    role-datasets-server: "true"
  replicas: 1
  resources:
    requests:
      cpu: 50m
      memory: "64Mi"
    limits:
      cpu: 1
      memory: "256Mi"

# --- reverse proxy ---

reverseProxy:
  nodeSelector:
    role-datasets-server: "true"
  replicas: 2
  resources:
    requests:
      cpu: 1
      memory: "64Mi"
    limits:
      cpu: 1
      memory: "256Mi"
  service:
    type: NodePort
  tolerations:
    - key: CriticalAddonsOnly
      operator: Equal

ingress:
  tls:
    - hosts:
      - "datasets-server.huggingface.co"
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:707930574880:certificate/971187a3-2baa-40e5-bcae-94d6ec55cd24
    alb.ingress.kubernetes.io/load-balancer-name: "hub-datasets-server-prod"
    alb.ingress.kubernetes.io/tags: "Env=prod,Project=datasets-server,Terraform=true"
    alb.ingress.kubernetes.io/target-node-labels: role-datasets-server=true
    alb.ingress.kubernetes.io/healthcheck-path: "/healthcheck"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80, "HTTPS": 443}]'
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    alb.ingress.kubernetes.io/group.name: "datasets-server"
    kubernetes.io/ingress.class: "alb"

# --- services ---

admin:
  # Number of reports in /cache-reports/... endpoints
  cacheReportsNumResults: 1000
  # Number of reports in /cache-reports-with-content/... endpoints
  cacheReportsWithContentNumResults: 100
  # the timeout in seconds for the requests to the Hugging Face Hub.
  hfTimeoutSeconds: "1.5"
  # Number of uvicorn workers for running the application
  # (2 x $num_cores) + 1
  # https://docs.gunicorn.org/en/stable/design.html#how-many-workers
  uvicornNumWorkers: "9"

  nodeSelector:
    role-datasets-server: "true"
  replicas: 1
  service:
    type: NodePort
  resources:
    requests:
      cpu: 1
      memory: "512Mi"
    limits:
      cpu: 4
      memory: "4Gi"

api:
  # the timeout in seconds for the requests to the Hugging Face Hub.
  hfTimeoutSeconds: "1.5"
  # Number of uvicorn workers for running the application
  # (2 x $num_cores) + 1
  # https://docs.gunicorn.org/en/stable/design.html#how-many-workers
  uvicornNumWorkers: "9"

  nodeSelector:
    role-datasets-server: "true"
  replicas: 4
  service:
    type: NodePort
  resources:
    requests:
      cpu: 1
      memory: "512Mi"
    limits:
      cpu: 4
      memory: "4Gi"

rows:
  # the timeout in seconds for the requests to the Hugging Face Hub.
  hfTimeoutSeconds: "1.5"
  # Number of uvicorn workers for running the application
  # (2 x $num_cores) + 1
  # https://docs.gunicorn.org/en/stable/design.html#how-many-workers
  uvicornNumWorkers: "9"

  nodeSelector:
    role-datasets-server: "true"
  replicas: 12
  service:
    type: NodePort
  resources:
    requests:
      cpu: 1
      memory: "2Gi"
    limits:
      cpu: 4
      memory: "8Gi"

workers:
  -
    deployName: "all"
    workerDifficultyMax: 100
    workerDifficultyMin: 0
    workerJobTypesBlocked: ""
    workerJobTypesOnly: ""
    nodeSelector:
      role-datasets-server-worker: "true"
    replicas: 20
    resources:
      requests:
        cpu: 1
        memory: "4Gi"
      limits:
        cpu: 2
        memory: "8Gi"
    tolerations: []
  -
    deployName: "light"
    workerDifficultyMax: 40
    workerDifficultyMin: 0
    workerJobTypesBlocked: ""
    workerJobTypesOnly: ""
    nodeSelector:
      role-datasets-server-worker: "true"
    replicas: 6
    resources:
      requests:
        cpu: 200m
        memory: "100Mi"
      limits:
        cpu: 2
        memory: "1Gi"
    tolerations: []
